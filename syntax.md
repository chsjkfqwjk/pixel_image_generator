# 像素图像生成器语法参考文档

## 目录
- [基础语法](#基础语法)
  - [config：配置图像](#config配置图像)
  - [color：定义颜色](#color定义颜色)
  - [region：定义区域](#region定义区域)
  - [fill：填充区域](#fill填充区域)
  - [gradient：渐变填充](#gradient渐变填充)
  - [points：点阵绘制](#points点阵绘制)
  - [path：路径绘制](#path路径绘制)
  - [transform：变换操作](#transform变换操作)
  - [var：变量定义](#var变量定义)
- [高级语法](#高级语法)
  - [if：条件语法](#if条件语法)
  - [loop：循环语法](#loop循环语法)
  - [变量与表达式](#变量与表达式)
  - [花括号表达式](#花括号表达式)
  - [三元表达式](#三元表达式)
  - [嵌套循环](#嵌套循环)
- [性能优化](#性能优化)
  - [循环优化](#循环优化)
  - [表达式缓存](#表达式缓存)
  - [渲染策略](#渲染策略)

## 基础语法

**语法规则**：所有命令必须在一行内完成，参数间使用反斜杠`\`分隔。

```
命令:参数1\参数2\参数3...
```

### config：配置图像

配置图像的尺寸和背景颜色。通常作为第一条指令。

**语法格式：**
```
config:宽度\高度\背景红\背景绿\背景蓝
```

**参数说明：**
- `宽度`：图像宽度（像素），必须为正整数
- `高度`：图像高度（像素），必须为正整数
- `背景红/绿/蓝`：RGB颜色值（0-255）

**示例：**
```
config:800\600\240\240\240  # 创建800x600的灰色背景图像
```

### color：定义颜色

定义一个可在后续指令中引用的颜色。

**语法格式：**
```
color:颜色ID\红\绿\蓝[\透明度]
```

**参数说明：**
- `颜色ID`：颜色的唯一标识符
- `红/绿/蓝`：RGB颜色值（0-255）
- `透明度`：可选参数，0-255，默认为255（完全不透明）

**示例：**
```
color:blue\0\0\255            # 定义纯蓝色
color:red\255\0\0             # 定义纯红色
color:semi_blue\0\0\255\128   # 定义半透明蓝色
```

### region：定义区域

定义一个可在后续指令中引用的区域。

**语法格式：**
```
region:区域ID\x1|y1\x2|y2[\形状]
```

**参数说明：**
- `区域ID`：区域的唯一标识符
- `x1|y1`：左上角坐标（x和y值用|分隔）
- `x2|y2`：右下角坐标（x和y值用|分隔）
- `形状`：可选参数，支持以下形状：
  - `rect`：矩形（默认）
  - `ellipse`：椭圆形
  - `triangle`：三角形
  - `diamond`：菱形
  - `pentagon`：五边形
  - `hexagon`：六边形
  - `star`：五角星
  - `cross`：十字形
  - `arrow`：箭头
  - 自定义多边形：直接使用格式为`"x1|y1-x2|y2-x3|y3-..."`的坐标点列表

**关于自定义多边形：**
- 使用连字符`-`分隔不同的点
- 使用竖线`|`分隔每个点的x和y坐标
- 至少需要3个点才能形成有效的多边形
- 可以使用绝对坐标或相对坐标（0-1范围内的小数）
- 所有坐标都是相对于区域左上角(x1|y1)的位置

**示例：**
```
region:box\10|10\100|100           # 定义矩形区域
region:circle\200|200\300|300\ellipse  # 定义椭圆区域
region:tri\50|50\150|150\triangle    # 定义三角形区域
region:diamond\20|20\120|120\diamond  # 定义菱形区域
region:star\150|150\250|250\star      # 定义五角星区域
region:custom\50|50\150|150\0|0-100|0-50|100  # 定义三角形自定义区域
region:complex\200|200\300|300\0.0|0.0-1.0|0.0-0.5|1.0  # 使用相对坐标
```

### fill：填充区域

用指定颜色填充已定义的区域。

**语法格式：**
```
fill:区域ID\颜色ID或RGB值
```

**参数说明：**
- `区域ID`：要填充的区域标识符
- `颜色ID或RGB值`：要使用的颜色标识符或RGB值

**示例：**
```
fill:box\blue      # 用蓝色填充box区域
fill:circle\red    # 用红色填充circle区域
fill:box\255\0\0    # 直接使用RGB值填充
```

### gradient：渐变填充

使用渐变色填充区域。

**语法格式：**
```
gradient:区域ID\类型\起点x|起点y\终点x|终点y\颜色ID1\颜色ID2
```

**参数说明：**
- `区域ID`：要填充的区域标识符
- `类型`：渐变类型，可为"linear"（线性）或"radial"（径向）
- `起点x|起点y`：渐变起点坐标，使用"|"分隔x和y
- `终点x|终点y`：渐变终点坐标，使用"|"分隔x和y
- `颜色ID1`：起点颜色
- `颜色ID2`：终点颜色

**示例：**
```
gradient:box\linear\0|0\100|100\blue\red    # 线性渐变，从蓝色到红色
gradient:circle\radial\250|250\300|300\yellow\green  # 径向渐变，从黄色到绿色
```

### points：点阵绘制

在区域内绘制点阵图案。

**语法格式：**
```
points:区域ID\颜色ID\模式\密度[\大小]
```

**参数说明：**
- `区域ID`：目标区域
- `颜色ID`：点的颜色
- `模式`：分布模式，可为"random"（随机）、"grid"（网格）或"hex"（六边形网格）
- `密度`：点的密度，范围0-1
- `大小`：可选参数，点的大小（像素），默认为1

**示例：**
```
points:box\white\random\0.1\2    # 随机白点，10%密度，2像素大小
points:circle\red\grid\0.5       # 网格红点，50%密度
```

### path：路径绘制

绘制连接多个点的路径。

**语法格式：**
```
path:点列表\颜色ID\宽度[\样式]
```

**参数说明：**
- `点列表`：格式为"x1|y1-x2|y2-..."，使用竖线分隔x和y，短横线分隔点
- `颜色ID`：路径颜色
- `宽度`：路径宽度（像素）
- `样式`：可选参数，可为"line"（默认）、"dashed"、"dotted"、"wave"、"closed"（封闭路径）

**示例：**
```
path:10|10-100|10-100|100-10|100\blue\2            # 蓝色矩形轮廓
path:50|50-150|50-100|150\red\3\dashed             # 红色虚线
path:200|50-300|150-400|50\green\2\wave\closed     # 绿色波浪闭合路径
```

### transform：变换操作

对已定义区域应用变换。

**语法格式：**
```
transform:区域ID\操作类型\参数
```

**参数说明：**
- `区域ID`：要变换的区域
- `操作类型`：可为"rotate"（旋转）、"scale"（缩放）、"translate"（平移）、"flip"（翻转）
- `参数`：根据操作类型不同而变化

**操作类型详解：**
1. `rotate`：旋转角度（度），如"45"
2. `scale`：缩放比例，格式为"x|y"，如"1.5|1.5"（x和y方向都放大1.5倍）
3. `translate`：平移距离，格式为"x|y"，如"10|20"（向右10像素，向下20像素）
4. `flip`：翻转方向，可为"horizontal"（水平）或"vertical"（垂直）

**示例：**
```
transform:box\rotate\45             # 将box区域顺时针旋转45度
transform:circle\scale\1.5|1.5      # 将circle区域放大1.5倍
transform:box\translate\20|30       # 将box区域向右移动20像素，向下移动30像素
transform:circle\flip\horizontal     # 水平翻转circle区域
```

### var：变量定义

定义一个可在后续指令中使用的变量。

**语法格式：**
```
var:变量名\值
```

**参数说明：**
- `变量名`：变量的标识符，只能包含字母、数字和下划线
- `值`：变量的值，可以是数字、文本或表达式

**示例：**
```
var:width\800              # 定义宽度变量
var:height\600             # 定义高度变量
var:centerX\{width/2}      # 定义变量为表达式结果
```

## 高级语法

高级语法提供条件判断、循环和表达式计算等功能，使图像生成更加灵活。

### if：条件语法

根据条件执行一条或多条指令。

**语法格式：**
```
if:条件表达式;指令1,指令2,...
```

**参数说明：**
- `条件表达式`：判断条件，如`width > 100`
- `指令1,指令2,...`：条件满足时执行的指令，用逗号分隔

**支持的运算符：**
- 比较运算符：`==`、`!=`、`<`、`>`、`<=`、`>=`
- 逻辑运算符：`and`、`or`、`not`

**示例：**
```
if:width > 600;region:large\0|0\width|height,fill:large\blue  # 当宽度大于600时创建并填充区域
if:x < 10 and y > 20;color:special\255\0\0,fill:box\special  # 复合条件
```

### loop：循环语法

循环执行一组指令多次。

**语法格式：**
```
loop:变量\起始值\结束值\步长;指令1,指令2,...
```

**参数说明：**
- `变量`：循环变量名
- `起始值`：循环起始值
- `结束值`：循环结束值
- `步长`：每次迭代增加的值
- `指令1,指令2,...`：要循环执行的指令，用逗号分隔

**注意事项：**
- 循环体与循环头使用分号`;`分隔
- 循环体内的多条指令使用逗号`,`分隔
- 所有代码必须在单行内完成
- 循环次数上限为1000次，防止无限循环
- 循环执行遵循"先颜色、后区域、最后其他指令"的顺序

**示例：**
```
# 创建5个不同颜色的方块，位置依次偏移
loop:i\0\4\1;color:c{i}\{i*50}\100\{255-i*50},region:r{i}\{i*50}|{i*50}\{i*50+40}|{i*50+40},fill:r{i}\c{i}
```

### 变量与表达式

在命令参数中可以使用变量和表达式实现动态计算。

**变量引用：**
- 直接引用：在参数中直接使用变量名
- 表达式引用：在花括号内使用变量，如`{x}`、`{y+10}`

**内置变量：**
- `width`：图像宽度
- `height`：图像高度

**示例：**
```
region:dynamic\x|y\{x+100}|{y+100}  # 使用x和y变量定义区域
region:centered\{width/2-50}|{height/2-50}\{width/2+50}|{height/2+50}  # 使用内置变量
```

### 花括号表达式

花括号`{}`内可以包含数学表达式进行动态计算。

**语法格式：**
```
{表达式}
```

**支持的运算：**
- 基本算术：`+`、`-`、`*`、`/`（浮点除法）、`//`（整除）、`%`（取余）、`**`（幂）
- 数学函数：`sin`、`cos`、`tan`、`sqrt`、`pow`、`abs`、`min`、`max`、`round`、`floor`、`ceil`
- 常量：`pi`、`e`

**示例：**
```
region:math_box\{10+5*20}|{sqrt(100)}\{pow(2,8)}|{floor(15.7)}  # 使用数学表达式
color:calc\{min(255, x*2)}\{max(0, y-50)}\{abs(x-y)}             # 计算颜色值
```

### 三元表达式

提供条件判断功能的特殊表达式，格式为`条件?真值:假值`。

**语法格式：**
```
{条件?真值:假值}
```

**示例：**
```
fill:box\{x>300?red:blue}                                # 条件选择颜色
region:dynamic\{y<200?0:y-200}|0\{y<200?y:y+100}|height  # 条件决定区域位置
```

### 嵌套循环

可以在循环内部嵌套另一个循环，创建更复杂的图案。

**语法格式：**
```
loop:外层变量\起始值\终止值\步长;loop:内层变量\起始值\终止值\步长;指令1,指令2,...
```

**变量作用域：**
- 外层循环变量在内层循环中可用
- 内层循环变量在外层循环后续指令中不可用
- 所有嵌套循环仍必须在单行内完成

**命名约定：**
- 在区域ID中使用`_{变量名}`引用变量，如`box_{x}_{y}`
- 在表达式中使用`{变量名}`引用变量，如`{x+y}`

**示例：**
```
# 创建5x5网格，颜色基于坐标
loop:x\0\4\1;loop:y\0\4\1;region:cell_{x}_{y}\{x*50}|{y*50}\{x*50+45}|{y*50+45},fill:cell_{x}_{y}\{(x+y)%2==0?red:blue}

# 创建同心圆环
loop:r\10\100\10;region:ring_{r}\{width/2-r}|{height/2-r}\{width/2+r}|{height/2+r}\ellipse,fill:ring_{r}\{r%20==0?red:blue}
```

## 性能优化

以下是使用像素图像生成器的优化建议，帮助提高复杂图像的生成效率。

### 循环优化

使用循环生成大量元素时的优化策略：

1. **执行顺序优化**：循环指令会自动分为三类（颜色定义、区域定义、其他操作）并按顺序执行
   ```
   # 颜色和区域定义会自动优先处理
   loop:i\0\9\1;color:c{i}\{i*25}\100\200,region:r{i}\{i*50}|{i*50}\{i*50+40}|{i*50+40},fill:r{i}\c{i}
   ```

2. **合理步长**：选择适当的步长避免不必要的迭代
   ```
   # 使用20作为步长，比使用1作步长更高效
   loop:x\0\400\20;region:r_{x}\{x}|10\{x+15}|100,fill:r_{x}\blue
   ```

3. **避免深度嵌套**：控制循环嵌套不超过2-3层
   ```
   # 两层嵌套是合理的
   loop:x\0\3\1;loop:y\0\3\1;region:r_{x}_{y}\{x*100}|{y*100}\{x*100+90}|{y*100+90},fill:r_{x}_{y}\red
   ```

### 表达式缓存

程序实现了表达式计算缓存机制，提升复杂计算性能：

1. **自动缓存**：相同表达式计算结果会被自动缓存，避免重复计算
   ```
   # {i*50}的计算结果会被缓存，不会在每次循环中重新计算
   loop:i\0\20\1;region:r_{i}\{i*50}|0\{i*50+40}|50,fill:r_{i}\blue
   ```

2. **条件表达式优化**：使用简单条件代替复杂条件
   ```
   # 使用简单的条件表达式
   fill:box\{i%2==0?red:blue}  # 更高效
   ```

### 渲染策略

当生成包含大量元素的复杂图像时：

1. **预定义资源**：在循环外预先定义颜色，而不是在循环内创建
   ```
   # 高效方式：在循环外定义颜色
   color:red\255\0\0
   color:blue\0\0\255
   loop:i\0\100\1;region:r_{i}\{i}|0\{i+5}|10,fill:r_{i}\{i%2==0?red:blue}
   ```

2. **区域合并**：可能的情况下，合并相似区域减少区域总数
   ```
   # 不是为每个像素定义区域，而是定义更大的块
   region:block\0|0\100|100
   fill:block\blue
   ```

3. **图像尺寸选择**：选择合适的分辨率，避免过高的像素数
   ```
   # 选择合理的图像尺寸
   config:800\600\255\255\255  # 比 1600x1200 更高效
   ```

通过遵循这些优化策略，可以显著提高复杂图像的生成效率，创建更丰富的视觉效果。
